<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>Shopping Lists</title>
    <link rel="manifest" href="site.webmanifest" />
    <link rel="icon" type="image/jpeg" href="images/app-icon.jpg" />
    <link rel="apple-touch-icon" href="images/app-icon.jpg" />
    <meta name="theme-color" content="#fff0f6" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Shopping Lists" />
    <style>
        :root {
            --bg: #fff0f6;
            --card: rgba(255, 255, 255, 0.9);
            --cardSolid: #ffffff;
            --text: #1c1c1e;
            --subtext: #6b6b75;
            --line: rgba(60, 60, 67, 0.18);
            --shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
            --shadowSm: 0 6px 18px rgba(0, 0, 0, 0.06);
            --blue: #ff4d8d;
            --green: #34c759;
            --red: #ff3b30;
            --orange: #ff9fbc;
            --radius: 18px;
            --radiusSm: 14px;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            color: var(--text);
            background:
                radial-gradient(1200px 700px at 50% -10%, rgba(255, 77, 141, 0.18), transparent 60%),
                radial-gradient(900px 520px at 110% 20%, rgba(255, 159, 188, 0.14), transparent 60%),
                radial-gradient(900px 520px at -10% 50%, rgba(255, 210, 225, 0.18), transparent 60%),
                var(--bg);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Top bar */
        .topbar {
            position: sticky;
            top: 0;
            z-index: 10;
            padding: calc(10px + var(--safe-top)) 14px 10px;
            background: rgba(242, 242, 247, 0.72);
            backdrop-filter: blur(18px);
            -webkit-backdrop-filter: blur(18px);
            border-bottom: 1px solid rgba(60, 60, 67, 0.12);
        }

        .toprow {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .titlewrap {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 0;
        }

        .title {
            font-size: 20px;
            font-weight: 700;
            letter-spacing: -0.02em;
            line-height: 1.2;
        }

        .subtitle {
            font-size: 13px;
            color: var(--subtext);
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            border-radius: 999px;
            border: 1px solid rgba(60, 60, 67, 0.14);
            background: rgba(255, 255, 255, 0.75);
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.8) inset;
            max-width: 52vw;
        }

        .pill select {
            border: none;
            background: transparent;
            font: inherit;
            font-weight: 600;
            letter-spacing: -0.01em;
            color: var(--text);
            outline: none;
            max-width: 44vw;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            -webkit-appearance: none;
            appearance: none;
            padding-right: 18px;
            cursor: pointer;
        }

        .chev {
            width: 10px;
            height: 10px;
            border-right: 2px solid rgba(60, 60, 67, 0.5);
            border-bottom: 2px solid rgba(60, 60, 67, 0.5);
            transform: rotate(45deg);
            margin-left: -14px;
            pointer-events: none;
        }

        .iconbtn {
            border: none;
            background: rgba(255, 255, 255, 0.74);
            border: 1px solid rgba(60, 60, 67, 0.14);
            width: 40px;
            height: 40px;
            border-radius: 999px;
            display: grid;
            place-items: center;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.75) inset;
            cursor: pointer;
            transition: transform .08s ease, filter .18s ease;
        }

        .iconbtn:active {
            transform: scale(0.98);
            filter: brightness(0.98);
        }

        /* Content */
        .content {
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex: 1;
            padding-bottom: calc(20px + var(--safe-bottom));
        }

        .card {
            background: var(--card);
            border: 1px solid rgba(60, 60, 67, 0.12);
            border-radius: var(--radius);
            box-shadow: var(--shadowSm);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            overflow: hidden;
        }

        .cardHeader {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(60, 60, 67, 0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .cardHeader h2 {
            margin: 0;
            font-size: 15px;
            font-weight: 700;
            letter-spacing: -0.015em;
        }

        .muted {
            color: var(--subtext);
            font-size: 12px;
            line-height: 1.2;
        }

        /* Inputs */
        .form {
            padding: 12px 14px 14px;
            display: grid;
            gap: 10px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .field {
            display: grid;
            gap: 6px;
        }

        label {
            font-size: 12px;
            color: var(--subtext);
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            border-radius: 14px;
            border: 1px solid rgba(60, 60, 67, 0.16);
            background: rgba(255, 255, 255, 0.85);
            padding: 12px 12px;
            font-size: 16px;
            outline: none;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.7) inset;
        }

        input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .actions {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }

        .btn {
            border: none;
            border-radius: 14px;
            padding: 12px 14px;
            font-size: 16px;
            font-weight: 700;
            letter-spacing: -0.01em;
            cursor: pointer;
            transition: transform .08s ease, filter .18s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            white-space: nowrap;
        }

        .btnPrimary {
            background: var(--blue);
            color: white;
            box-shadow: 0 10px 22px rgba(0, 122, 255, 0.22);
        }

        .btnGhost {
            background: rgba(255, 255, 255, 0.78);
            border: 1px solid rgba(60, 60, 67, 0.16);
            color: var(--text);
        }

        .btnDanger {
            background: rgba(255, 59, 48, 0.12);
            border: 1px solid rgba(255, 59, 48, 0.20);
            color: var(--red);
            font-weight: 800;
        }

        .btn:active {
            transform: scale(0.99);
            filter: brightness(0.98);
        }

        .seg {
            display: grid;
            grid-template-columns: 1fr 1fr;
            background: rgba(255, 255, 255, 0.72);
            border: 1px solid rgba(60, 60, 67, 0.14);
            border-radius: 14px;
            overflow: hidden;
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.72) inset;
        }

        .seg button {
            border: none;
            background: transparent;
            padding: 10px 12px;
            font-weight: 700;
            letter-spacing: -0.01em;
            cursor: pointer;
            color: var(--subtext);
        }

        .seg button.active {
            background: rgba(0, 122, 255, 0.12);
            color: var(--blue);
        }

        /* List */
        .list {
            display: grid;
        }

        .item {
            display: grid;
            grid-template-columns: 24px 1fr auto;
            gap: 10px;
            align-items: center;
            padding: 12px 14px;
            border-top: 1px solid rgba(60, 60, 67, 0.10);
            background: rgba(255, 255, 255, 0.55);
        }

        .item:first-child {
            border-top: none;
        }

        .check {
            width: 22px;
            height: 22px;
            border-radius: 7px;
            border: 1.5px solid rgba(60, 60, 67, 0.30);
            display: grid;
            place-items: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.75);
            box-shadow: 0 1px 0 rgba(255, 255, 255, 0.75) inset;
        }

        .check svg {
            opacity: 0;
            transform: scale(0.8);
            transition: opacity .12s ease, transform .12s ease;
        }

        .item.done .check {
            border-color: rgba(52, 199, 89, 0.45);
            background: rgba(52, 199, 89, 0.16);
        }

        .item.done .check svg {
            opacity: 1;
            transform: scale(1);
        }

        .text {
            min-width: 0;
            display: grid;
            gap: 2px;
        }

        .name {
            font-weight: 750;
            letter-spacing: -0.012em;
            font-size: 15px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .meta {
            font-size: 12px;
            color: var(--subtext);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .item.done .name {
            color: rgba(28, 28, 30, 0.55);
            text-decoration: line-through;
            text-decoration-thickness: 2px;
        }

        .itemBtns {
            display: inline-flex;
            gap: 8px;
            align-items: center;
        }

        .mini {
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.72);
            border: 1px solid rgba(60, 60, 67, 0.14);
            display: grid;
            place-items: center;
            cursor: pointer;
            transition: transform .08s ease, filter .18s ease;
        }

        .mini:active {
            transform: scale(0.98);
            filter: brightness(0.98);
        }

        .empty {
            padding: 18px 14px;
            text-align: center;
            color: var(--subtext);
            font-size: 14px;
        }

        /* Modal */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.26);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            display: none;
            align-items: flex-end;
            justify-content: center;
            padding: 12px;
            padding-bottom: calc(12px + var(--safe-bottom));
            z-index: 50;
        }

        .backdrop.show {
            display: flex;
        }

        .sheet {
            width: min(520px, 100%);
            background: rgba(255, 255, 255, 0.88);
            border: 1px solid rgba(60, 60, 67, 0.12);
            border-radius: 24px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .sheetHeader {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(60, 60, 67, 0.12);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .sheetHeader .grab {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: 46px;
            height: 5px;
            border-radius: 999px;
            background: rgba(60, 60, 67, 0.22);
            top: 8px;
        }

        .sheetHeader h3 {
            margin: 0;
            font-size: 15px;
            font-weight: 800;
            letter-spacing: -0.015em;
        }

        .sheetBody {
            padding: 12px 14px 14px;
            display: grid;
            gap: 12px;
        }

        /* Desktop polish */
        @media (min-width: 720px) {
            .content {
                width: 680px;
                margin: 0 auto;
            }

            .topbar {
                padding-left: 0;
                padding-right: 0;
            }

            .toprow {
                width: 680px;
                margin: 0 auto;
            }
        }

        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            * {
                transition: none !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body>
    <div class="app" role="application" aria-label="Shopping lists">
        <header class="topbar">
            <div class="toprow">
                <div class="titlewrap">
                    <div class="title">Shopping Lists</div>
                    <div class="subtitle" id="subtitle">Organize lists by store</div>
                </div>

                <div style="display:flex; gap:10px; align-items:center;">
                    <div class="pill" aria-label="Store picker">
                        <select id="storeSelect" aria-label="Select store"></select>
                        <div class="chev" aria-hidden="true"></div>
                    </div>
                    <button class="iconbtn" id="openStoreSheet" aria-label="Manage stores" title="Manage stores">
                        <!-- sliders icon -->
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                            <path d="M6 21v-7m0-4V3m12 18v-9m0-4V3" stroke="rgba(28,28,30,.82)" stroke-width="2"
                                stroke-linecap="round" />
                            <path d="M3 14h6M15 12h6" stroke="rgba(28,28,30,.82)" stroke-width="2"
                                stroke-linecap="round" />
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="content">
            <section class="card" aria-label="Add item">
                <div class="cardHeader">
                    <div>
                        <h2>Add Item</h2>
                        <div class="muted">Quickly add items to the selected store</div>
                    </div>
                    <div class="seg" aria-label="View mode">
                        <button id="modeAll" class="active" type="button">All</button>
                        <button id="modeOpen" type="button">To Buy</button>
                    </div>
                </div>
                <form class="form" id="addForm" autocomplete="off">
                    <div class="row">
                        <div class="field">
                            <label for="itemName">Item</label>
                            <input id="itemName" type="text" placeholder="e.g., Milk" required />
                        </div>
                    </div>
                    <div class="actions">
                        <div class="field">
                            <label for="itemQty">Qty (optional)</label>
                            <input id="itemQty" type="number" inputmode="numeric" min="1" placeholder="1" />
                        </div>
                        <button class="btn btnPrimary" type="submit" aria-label="Add item">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                            </svg>
                            Add
                        </button>
                    </div>
                </form>
            </section>

            <section class="card" aria-label="List items">
                <div class="cardHeader">
                    <div>
                        <h2 id="listTitle">List</h2>
                        <div class="muted" id="listMeta">0 items</div>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn btnGhost" id="clearDone" type="button" title="Clear checked"
                            aria-label="Clear checked items">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                                <path d="M9 11l2 2 4-4" stroke="rgba(28,28,30,.82)" stroke-width="2.5"
                                    stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" stroke="rgba(28,28,30,.35)"
                                    stroke-width="1.5" />
                            </svg>
                            Clear
                        </button>
                    </div>
                </div>
                <div class="list" id="list"></div>
                <div class="empty" id="empty" hidden>
                    Nothing here yet. Add your first item above.
                </div>
            </section>

            <section class="card" aria-label="Tips">
                <div class="cardHeader">
                    <div>
                        <h2>Tips</h2>
                        <div class="muted">Tap the checkbox to mark items done</div>
                    </div>
                </div>
                <div style="padding: 12px 14px 14px; color: var(--subtext); font-size: 13px; line-height: 1.4;">
                    <div>• Your lists save automatically on this device.</div>
                    <div>• Use <b>To Buy</b> to hide checked items.</div>
                    <div>• Manage store names from the top right button.</div>
                </div>
            </section>
        </main>
    </div>

    <!-- Store Management Sheet -->
    <div class="backdrop" id="storeBackdrop" role="dialog" aria-modal="true" aria-label="Manage stores"
        aria-hidden="true">
        <div class="sheet" role="document">
            <div class="sheetHeader" style="position: relative;">
                <div class="grab" aria-hidden="true"></div>
                <h3>Stores</h3>
                <button class="mini" id="closeStoreSheet" aria-label="Close">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M6 6l12 12M18 6 6 18" stroke="rgba(28,28,30,.72)" stroke-width="2.5"
                            stroke-linecap="round" />
                    </svg>
                </button>
            </div>
            <div class="sheetBody">
                <div class="field">
                    <label for="newStore">New store name</label>
                    <input id="newStore" type="text" placeholder="e.g., Trader Joe’s" />
                </div>
                <button class="btn btnPrimary" id="addStore" type="button">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                        <path d="M12 5v14M5 12h14" stroke="white" stroke-width="2.5" stroke-linecap="round" />
                    </svg>
                    Add Store
                </button>

                <div class="card" style="background: rgba(255,255,255,0.6);">
                    <div class="cardHeader">
                        <div>
                            <h2 style="font-size:14px;">Manage</h2>
                            <div class="muted">Rename or delete stores</div>
                        </div>
                    </div>
                    <div id="storeList"></div>
                </div>

                <button class="btn btnDanger" id="resetAll" type="button" title="Remove all stores and items">
                    Reset All Data
                </button>
            </div>
        </div>
    </div>

    <script>
        /**
         * Apple-ish Shopping Lists (single-file)
         * - Stores with user-defined names
         * - Items per store with quantity + done
         * - Filter: All vs To Buy
         * - localStorage persistence
         */

        const STORAGE_KEY = "appleish_shopping_lists_v1";

        /** @typedef {{ id:string, name:string, items: Item[] }} Store */
        /** @typedef {{ id:string, name:string, qty:number|null, done:boolean, createdAt:number }} Item */

        const $ = (sel, root = document) => root.querySelector(sel);
        const $$ = (sel, root = document) => Array.from(root.querySelectorAll(sel));

        const els = {
            storeSelect: $("#storeSelect"),
            subtitle: $("#subtitle"),
            listTitle: $("#listTitle"),
            listMeta: $("#listMeta"),
            list: $("#list"),
            empty: $("#empty"),
            addForm: $("#addForm"),
            itemName: $("#itemName"),
            itemQty: $("#itemQty"),
            clearDone: $("#clearDone"),
            modeAll: $("#modeAll"),
            modeOpen: $("#modeOpen"),

            openStoreSheet: $("#openStoreSheet"),
            storeBackdrop: $("#storeBackdrop"),
            closeStoreSheet: $("#closeStoreSheet"),
            newStore: $("#newStore"),
            addStore: $("#addStore"),
            storeList: $("#storeList"),
            resetAll: $("#resetAll"),
        };

        const uid = () => Math.random().toString(16).slice(2) + Date.now().toString(16);

        const defaultData = () => ({
            selectedStoreId: null,
            viewMode: "all", // all | open
            stores: [
                {
                    id: uid(),
                    name: "Grocery",
                    items: [
                        { id: uid(), name: "Milk", qty: 1, done: false, createdAt: Date.now() - 300000 },
                        { id: uid(), name: "Eggs", qty: 12, done: false, createdAt: Date.now() - 250000 },
                        { id: uid(), name: "Bananas", qty: 6, done: true, createdAt: Date.now() - 200000 },
                    ]
                },
                {
                    id: uid(),
                    name: "Pharmacy",
                    items: [
                        { id: uid(), name: "Toothpaste", qty: 1, done: false, createdAt: Date.now() - 150000 },
                    ]
                }
            ]
        });

        function load() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) return defaultData();
                const data = JSON.parse(raw);
                // basic shape guard
                if (!data || !Array.isArray(data.stores)) return defaultData();
                return data;
            } catch {
                return defaultData();
            }
        }

        function save() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
        }

        let state = load();
        if (!state.selectedStoreId && state.stores[0]) state.selectedStoreId = state.stores[0].id;

        function currentStore() {
            return state.stores.find(s => s.id === state.selectedStoreId) || state.stores[0] || null;
        }

        function setSubtitle() {
            const s = currentStore();
            if (!s) {
                els.subtitle.textContent = "No stores yet";
                return;
            }
            const open = s.items.filter(i => !i.done).length;
            els.subtitle.textContent = `${open} to buy • Saved on this device`;
        }

        function setMode(mode) {
            state.viewMode = mode;
            els.modeAll.classList.toggle("active", mode === "all");
            els.modeOpen.classList.toggle("active", mode === "open");
            save();
            render();
        }

        function renderStoreSelect() {
            const s = currentStore();
            els.storeSelect.innerHTML = "";
            state.stores.forEach(store => {
                const opt = document.createElement("option");
                opt.value = store.id;
                opt.textContent = store.name;
                if (s && store.id === s.id) opt.selected = true;
                els.storeSelect.appendChild(opt);
            });

            els.storeSelect.disabled = state.stores.length === 0;
        }

        function renderItems() {
            const s = currentStore();
            els.list.innerHTML = "";

            if (!s) {
                els.listTitle.textContent = "List";
                els.listMeta.textContent = "0 items";
                els.empty.hidden = false;
                return;
            }

            const all = [...s.items].sort((a, b) => {
                // open first, then newest
                if (a.done !== b.done) return a.done ? 1 : -1;
                return b.createdAt - a.createdAt;
            });

            const shown = state.viewMode === "open" ? all.filter(i => !i.done) : all;

            const total = s.items.length;
            const open = s.items.filter(i => !i.done).length;
            els.listTitle.textContent = s.name;
            els.listMeta.textContent = `${total} item${total === 1 ? "" : "s"} • ${open} to buy`;

            els.empty.hidden = shown.length !== 0;

            shown.forEach(item => {
                const row = document.createElement("div");
                row.className = "item" + (item.done ? " done" : "");
                row.dataset.id = item.id;

                const check = document.createElement("button");
                check.className = "check";
                check.type = "button";
                check.ariaLabel = item.done ? "Mark not done" : "Mark done";
                check.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 6 9 17l-5-5" stroke="rgba(28,28,30,.82)" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
                check.addEventListener("click", () => toggleDone(item.id));

                const text = document.createElement("div");
                text.className = "text";

                const name = document.createElement("div");
                name.className = "name";
                name.textContent = item.name;

                const meta = document.createElement("div");
                meta.className = "meta";
                meta.textContent = item.qty ? `Qty: ${item.qty}` : "";

                text.appendChild(name);
                text.appendChild(meta);

                const btns = document.createElement("div");
                btns.className = "itemBtns";

                const editBtn = document.createElement("button");
                editBtn.className = "mini";
                editBtn.type = "button";
                editBtn.title = "Edit";
                editBtn.ariaLabel = "Edit item";
                editBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M12 20h9" stroke="rgba(28,28,30,.7)" stroke-width="2.3" stroke-linecap="round"/>
            <path d="M16.5 3.5a2.1 2.1 0 0 1 3 3L7 19l-4 1 1-4 12.5-12.5Z" stroke="rgba(28,28,30,.7)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
                editBtn.addEventListener("click", () => editItem(item.id));

                const delBtn = document.createElement("button");
                delBtn.className = "mini";
                delBtn.type = "button";
                delBtn.title = "Delete";
                delBtn.ariaLabel = "Delete item";
                delBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 7h12" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round"/>
            <path d="M9 7V5.5A1.5 1.5 0 0 1 10.5 4h3A1.5 1.5 0 0 1 15 5.5V7" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round"/>
            <path d="M8 7l1 14h6l1-14" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
                delBtn.addEventListener("click", () => deleteItem(item.id));

                btns.appendChild(editBtn);
                btns.appendChild(delBtn);

                row.appendChild(check);
                row.appendChild(text);
                row.appendChild(btns);

                els.list.appendChild(row);
            });
        }

        function renderStoreManager() {
            els.storeList.innerHTML = "";

            if (state.stores.length === 0) {
                els.storeList.innerHTML = `<div class="empty">Add a store to get started.</div>`;
                return;
            }

            state.stores.forEach(store => {
                const row = document.createElement("div");
                row.className = "item";
                row.style.gridTemplateColumns = "1fr auto";

                const left = document.createElement("div");
                left.className = "text";
                left.style.gap = "3px";

                const name = document.createElement("div");
                name.className = "name";
                name.textContent = store.name;

                const meta = document.createElement("div");
                meta.className = "meta";
                const open = store.items.filter(i => !i.done).length;
                meta.textContent = `${store.items.length} item${store.items.length === 1 ? "" : "s"} • ${open} to buy`;

                left.appendChild(name);
                left.appendChild(meta);

                const btns = document.createElement("div");
                btns.className = "itemBtns";

                const renameBtn = document.createElement("button");
                renameBtn.className = "mini";
                renameBtn.type = "button";
                renameBtn.title = "Rename";
                renameBtn.ariaLabel = "Rename store";
                renameBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M4 20h4l10.5-10.5a2 2 0 0 0 0-2.8L17.3 5.5a2 2 0 0 0-2.8 0L4 16v4Z" stroke="rgba(28,28,30,.7)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M13.5 6.5l4 4" stroke="rgba(28,28,30,.7)" stroke-width="2.3" stroke-linecap="round"/>
          </svg>
        `;
                renameBtn.addEventListener("click", () => renameStore(store.id));

                const delBtn = document.createElement("button");
                delBtn.className = "mini";
                delBtn.type = "button";
                delBtn.title = "Delete";
                delBtn.ariaLabel = "Delete store";
                delBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 7h12" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round"/>
            <path d="M9 7V5.5A1.5 1.5 0 0 1 10.5 4h3A1.5 1.5 0 0 1 15 5.5V7" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round"/>
            <path d="M8 7l1 14h6l1-14" stroke="rgba(255,59,48,.9)" stroke-width="2.3" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
                delBtn.addEventListener("click", () => deleteStore(store.id));

                const pickBtn = document.createElement("button");
                pickBtn.className = "mini";
                pickBtn.type = "button";
                pickBtn.title = "Select";
                pickBtn.ariaLabel = "Select store";
                pickBtn.innerHTML = `
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M20 6 9 17l-5-5" stroke="rgba(52,199,89,.95)" stroke-width="2.8" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        `;
                pickBtn.addEventListener("click", () => {
                    state.selectedStoreId = store.id;
                    save();
                    render();
                    closeStores();
                });

                btns.appendChild(pickBtn);
                btns.appendChild(renameBtn);
                btns.appendChild(delBtn);

                row.appendChild(left);
                row.appendChild(btns);

                els.storeList.appendChild(row);
            });
        }

        function render() {
            renderStoreSelect();
            renderItems();
            renderStoreManager();
            setSubtitle();

            // disable clear button if no done items
            const s = currentStore();
            const anyDone = s ? s.items.some(i => i.done) : false;
            els.clearDone.disabled = !anyDone;
            els.clearDone.style.opacity = anyDone ? "1" : "0.55";

            // focus add field when list exists
            if (state.stores.length > 0) els.itemName.placeholder = `e.g., Milk (${currentStore().name})`;
            else els.itemName.placeholder = "Add a store first";

            // disable add form if no stores
            const disabled = state.stores.length === 0;
            els.itemName.disabled = disabled;
            els.itemQty.disabled = disabled;
            els.addForm.querySelector("button[type=submit]").disabled = disabled;
            els.addForm.querySelector("button[type=submit]").style.opacity = disabled ? "0.6" : "1";

            // view mode buttons reflect state
            els.modeAll.classList.toggle("active", state.viewMode === "all");
            els.modeOpen.classList.toggle("active", state.viewMode === "open");
        }

        // Actions
        function addItem(name, qty) {
            const s = currentStore();
            if (!s) return;
            s.items.push({ id: uid(), name: name.trim(), qty: qty ?? null, done: false, createdAt: Date.now() });
            save();
            render();
        }

        function toggleDone(itemId) {
            const s = currentStore();
            if (!s) return;
            const it = s.items.find(i => i.id === itemId);
            if (!it) return;
            it.done = !it.done;
            save();
            render();
        }

        function deleteItem(itemId) {
            const s = currentStore();
            if (!s) return;
            s.items = s.items.filter(i => i.id !== itemId);
            save();
            render();
        }

        function editItem(itemId) {
            const s = currentStore();
            if (!s) return;
            const it = s.items.find(i => i.id === itemId);
            if (!it) return;

            const newName = prompt("Edit item name", it.name);
            if (newName === null) return;
            const trimmed = newName.trim();
            if (!trimmed) return;

            const newQtyRaw = prompt("Edit quantity (leave blank for none)", it.qty ?? "");
            if (newQtyRaw === null) return;
            const q = String(newQtyRaw).trim();
            const parsed = q === "" ? null : Math.max(1, parseInt(q, 10));

            it.name = trimmed;
            it.qty = Number.isFinite(parsed) ? parsed : null;
            save();
            render();
        }

        function clearDone() {
            const s = currentStore();
            if (!s) return;
            s.items = s.items.filter(i => !i.done);
            save();
            render();
        }

        function addStore(name) {
            const trimmed = name.trim();
            if (!trimmed) return;
            const store = { id: uid(), name: trimmed, items: [] };
            state.stores.unshift(store);
            state.selectedStoreId = store.id;
            save();
            render();
        }

        function renameStore(storeId) {
            const store = state.stores.find(s => s.id === storeId);
            if (!store) return;
            const next = prompt("Rename store", store.name);
            if (next === null) return;
            const trimmed = next.trim();
            if (!trimmed) return;
            store.name = trimmed;
            save();
            render();
        }

        function deleteStore(storeId) {
            const store = state.stores.find(s => s.id === storeId);
            if (!store) return;

            const ok = confirm(`Delete \"${store.name}\" and its items?`);
            if (!ok) return;

            state.stores = state.stores.filter(s => s.id !== storeId);
            if (state.selectedStoreId === storeId) {
                state.selectedStoreId = state.stores[0]?.id ?? null;
            }
            save();
            render();
        }

        function resetAll() {
            const ok = confirm("Reset all stores and items on this device?");
            if (!ok) return;
            state = defaultData();
            state.selectedStoreId = state.stores[0]?.id ?? null;
            save();
            render();
            closeStores();
        }

        // Sheet open/close
        function openStores() {
            els.storeBackdrop.classList.add("show");
            els.storeBackdrop.setAttribute("aria-hidden", "false");
            setTimeout(() => els.newStore.focus(), 50);
        }

        function closeStores() {
            els.storeBackdrop.classList.remove("show");
            els.storeBackdrop.setAttribute("aria-hidden", "true");
            els.openStoreSheet.focus();
        }

        // Events
        els.addForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const name = els.itemName.value;
            const qtyRaw = els.itemQty.value.trim();
            const qty = qtyRaw ? Math.max(1, parseInt(qtyRaw, 10)) : null;

            if (!name.trim()) return;
            addItem(name, Number.isFinite(qty) ? qty : null);

            els.itemName.value = "";
            els.itemQty.value = "";
            els.itemName.focus();
        });

        els.storeSelect.addEventListener("change", () => {
            state.selectedStoreId = els.storeSelect.value;
            save();
            render();
        });

        els.clearDone.addEventListener("click", clearDone);

        els.modeAll.addEventListener("click", () => setMode("all"));
        els.modeOpen.addEventListener("click", () => setMode("open"));

        els.openStoreSheet.addEventListener("click", openStores);
        els.closeStoreSheet.addEventListener("click", closeStores);

        els.addStore.addEventListener("click", () => {
            addStore(els.newStore.value);
            els.newStore.value = "";
            els.newStore.focus();
        });

        els.newStore.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
                e.preventDefault();
                els.addStore.click();
            }
        });

        els.resetAll.addEventListener("click", resetAll);

        // Backdrop click closes
        els.storeBackdrop.addEventListener("click", (e) => {
            if (e.target === els.storeBackdrop) closeStores();
        });

        // Escape closes sheet
        window.addEventListener("keydown", (e) => {
            if (e.key === "Escape" && els.storeBackdrop.classList.contains("show")) closeStores();
        });

        // Initial render
        render();
    </script>
</body>


</html>
